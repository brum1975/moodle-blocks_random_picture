YUI.add('moodle-block_random_picture-lightbox',function(Y){var L=Y.Lang,Node=Y.Node,PX="px",CLICK="click",ANIM="anim",ACTIVE_IMAGE="activeImage",IMAGE_ARRAY="imageArray",OVERLAY_OPACITY="overlayOpacity",OVERLAY_DURATION="overlayDuration",LIGHTBOX="lightbox",OVERLAY="overlay",PREV_LINK="prevLink",NEXT_LINK="nextLink",HOVER_NAV="hoverNav",lightboxInstance=null;Y.mix(Node.prototype,{show:function(){this.setStyle("display","");return this;},hide:function(){this.setStyle("display","none");return this;},displayed:function(){return this.getStyle("display")!="none";},toggle:function(){this[this.displayed()?"hide":"show"]();return this;}});var LB=function(config){LB.superclass.constructor.apply(this,arguments);};LB.NAME=LIGHTBOX;LB.ATTRS={selector:{value:"a[rel^=lightbox]",validator:L.isString},borderWidth:{value:10,validator:L.isNumber},overlayDuration:{value:0.2,validator:L.isNumber},overlayOpacity:{value:0.8,validator:L.isNumber},resizeDuration:{value:0.5,validator:L.isNumber},anim:{value:!L.isUndefined(Y.Anim),validator:L.isBoolean},imageArray:{validator:L.isArray},activeImage:{validator:L.isNumber},strings:{value:{labelImage:"Image",labelOf:"of"}}};Y.extend(LB,Y.Base,{initializer:function(config){var objBody=Y.one(document.body),create=Node.create;objBody.append(create('<div id="overlay"></div>'));objBody.append(create('<div id="lightbox"></div>').append(create('<div id="outerImageContainer"></div>').append(create('<div id="imageContainer"></div>').append(create('<img id="lightboxImage" />')).append(create('<div id="hoverNav"></div>').append(create('<a id="prevLink" href="#"></a>')).append(create('<a id="nextLink" href="#"></a>'))).append(create('<div id="loading"></div>')))).append(create('<div id="imageDataContainer"></div>').append(create('<div id="imageData"></div>').append(create('<div id="imageDetails"></div>').append(create('<span id="caption"></span>')).append(create('<span id="numberDisplay"></span>'))).append(create('<div id="bottomNav"></div>').append(create('<a id="bottomNavClose" href="#"></a>'))))));this._bindStartListener();Y.one("#overlay").hide().on(CLICK,function(){this.end();},this);Y.one("#lightbox").hide().on(CLICK,function(evt){if(evt.currentTarget.get("id")===LIGHTBOX){this.end();}},this);var size=(this.get(ANIM)?250:1)+PX;Y.one("#outerImageContainer").setStyles({width:size,height:size});Y.one("#prevLink").on(CLICK,function(evt){evt.halt();this._changeImage(this.get(ACTIVE_IMAGE)-1);},this);Y.one("#nextLink").on(CLICK,function(evt){evt.halt();this._changeImage(this.get(ACTIVE_IMAGE)+1);},this);Y.one("#bottomNavClose").on(CLICK,function(evt){evt.halt();this.end();},this);L.later(0,this,function(){var ids="overlay lightbox outerImageContainer imageContainer lightboxImage hoverNav prevLink nextLink loading "+"imageDataContainer imageData imageDetails caption numberDisplay bottomNav bottomNavClose";Y.Array.each(ids.split(" "),function(element,index,array){this.addAttr(element,{value:Y.one("#"+element)});},this);});},start:function(selectedLink){Y.all("select, object, embed").each(function(){this.setStyle("visibility","hidden");});var overlay=this.get(OVERLAY).setStyles({height:Y.DOM.docHeight()+PX,width:Y.DOM.docWidth()+PX}).show();if(this.get(ANIM)){var anim=new Y.Anim({node:overlay,from:{opacity:0},to:{opacity:this.get(OVERLAY_OPACITY)},duration:this.get(OVERLAY_DURATION)});anim.run();}else{overlay.setStyle("opacity",this.get(OVERLAY_OPACITY));}var imageArray=[],imageNum=0;if(selectedLink.get("rel")===LIGHTBOX){imageArray.push([selectedLink.get("href"),selectedLink.get("title")]);}else{Y.all(selectedLink.get("tagName")+'[href][rel="'+selectedLink.get("rel")+'"]').each(function(){imageArray.push([this.get("href"),this.get("title")]);});while(imageArray[imageNum][0]!==selectedLink.get("href")){imageNum++;}}this.set(IMAGE_ARRAY,imageArray);var lightboxTop=Y.DOM.docScrollY()+(Y.DOM.winHeight()/10),lightboxLeft=Y.DOM.docScrollX();this.get(LIGHTBOX).setStyles({display:"",top:lightboxTop+PX,left:lightboxLeft+PX});this._changeImage(imageNum);},end:function(){this._disableKeyboardNav();this.get(LIGHTBOX).hide();var overlay=this.get(OVERLAY);if(this.get(ANIM)){var anim=new Y.Anim({node:overlay,from:{opacity:this.get(OVERLAY_OPACITY)},to:{opacity:0},duration:this.get(OVERLAY_DURATION)});anim.on("end",function(){overlay.hide();});anim.run();}else{overlay.setStyles({opacity:0}).hide();}Y.all("select, object, embed").each(function(){this.setStyle("visibility","visible");});},_bindStartListener:function(){Y.delegate(CLICK,Y.bind(function(evt){evt.halt();this.start(evt.currentTarget);},this),document.body,this.get("selector"));},_changeImage:function(imageNum){this.set(ACTIVE_IMAGE,imageNum);if(this.get(ANIM)){this.get("loading").show();}this.get("lightboxImage").hide();this.get(HOVER_NAV).hide();this.get(PREV_LINK).hide();this.get(NEXT_LINK).hide();this.get("imageDataContainer").setStyle("opacity",0.0001);this.get("numberDisplay").hide();var imagePreloader=new Image();imagePreloader.onload=Y.bind(function(){this.get("lightboxImage").set("src",this.get(IMAGE_ARRAY)[imageNum][0]);viewportWidth=YAHOO.util.Dom.getViewportWidth();viewportHeight=YAHOO.util.Dom.getViewportHeight();widthRatio=(viewportWidth-50)/imagePreloader.width;heightRatio=(viewportHeight-250)/imagePreloader.height;if(widthRatio>1&&heightRatio>1){bestRatio=1;}else if(widthRatio<heightRatio){var bestRatio=widthRatio;}else{var bestRatio=heightRatio;}imgWidth=imagePreloader.width*bestRatio;imgHeight=imagePreloader.height*bestRatio;this._resizeImageContainer(imgWidth,imgHeight);},this);imagePreloader.src=this.get(IMAGE_ARRAY)[imageNum][0];},_resizeImageContainer:function(imgWidth,imgHeight){var outerImageContainer=this.get("outerImageContainer"),widthCurrent=outerImageContainer.get("offsetWidth"),heightCurrent=outerImageContainer.get("offsetHeight"),widthNew=imgWidth+this.get("borderWidth")*2,heightNew=imgHeight+this.get("borderWidth")*2,wDiff=widthCurrent-widthNew,hDiff=heightCurrent-heightNew,afterResize=Y.bind(function(){this.get(PREV_LINK).setStyles({height:imgHeight+PX});this.get(NEXT_LINK).setStyles({height:imgHeight+PX});this.get("imageDataContainer").setStyles({width:widthNew+PX});this._showImage(imgWidth,imgHeight);},this);if(wDiff!==0||hDiff!==0){if(this.get(ANIM)){var resizeDuration=this.get("resizeDuration"),anim=new Y.Anim({node:outerImageContainer,from:{width:widthCurrent+PX},to:{width:widthNew+PX},duration:resizeDuration}),onEnd=function(){anim.getEvent("end").detach(onEnd);this.setAttrs({from:{height:heightCurrent+PX},to:{height:heightNew+PX},duration:resizeDuration});this.on("end",afterResize);this.run();};anim.on("end",onEnd);anim.run();}else{outerImageContainer.setStyles({width:widthNew+PX,height:heightNew+PX});L.later(0,this,afterResize);}}else{L.later(100,this,afterResize);}},_showImage:function(imgWidth,imgHeight){this.get("loading").hide();var lightBoxImage=this.get("lightboxImage");if(this.get(ANIM)){var startOpacity=lightBoxImage.getStyle("display")==="none"?0:lightBoxImage.getStyle("opacity")||0,anim=new Y.Anim({node:lightBoxImage,from:{opacity:startOpacity},to:{opacity:1}});anim.on("end",this._updateDetails,this);lightBoxImage.setStyle("width",imgWidth+'px');lightBoxImage.setStyle("height",imgHeight+'px');lightBoxImage.setStyle("opacity",startOpacity).show();anim.run();}else{lightBoxImage.setStyle("opacity",1).show();this._updateDetails();}this._preloadNeighborImages();},_updateDetails:function(){var imageArray=this.get(IMAGE_ARRAY),activeImage=this.get(ACTIVE_IMAGE),caption=imageArray[activeImage][1];if(caption!==""){this.get("caption").setContent(caption).show();}if(imageArray.length>1){this.get("numberDisplay").setContent(this.get("strings.labelImage")+" "+(activeImage+1)+" "+this.get("strings.labelOf")+"  "+imageArray.length).show();}var imageDataContainer=this.get("imageDataContainer");if(this.get(ANIM)){var startOpacity=imageDataContainer.getStyle("display")==="none"?0:imageDataContainer.getStyle("opacity")||0,anim=new Y.Anim({node:imageDataContainer,from:{opacity:startOpacity},to:{opacity:1},duration:this.get("resizeDuration")});anim.on("end",function(){this.get(OVERLAY).setStyle("height",Y.DOM.docHeight()+PX);this._updateNav();},this);imageDataContainer.setStyle("opacity",startOpacity).show();anim.run();}else{imageDataContainer.setStyle("opacity",1).show();this.get(OVERLAY).setStyle("height",Y.DOM.docHeight()+PX);this._updateNav();}},_updateNav:function(){var activeImage=this.get(ACTIVE_IMAGE);this.get(HOVER_NAV).show();if(activeImage>0){this.get(PREV_LINK).show();}if(activeImage<(this.get(IMAGE_ARRAY).length-1)){this.get(NEXT_LINK).show();}this._enableKeyboardNav();},_enableKeyboardNav:function(){Y.get(document.body).on("keydown",this._keyboardAction,this);},_disableKeyboardNav:function(){Y.get(document.body).unsubscribe("keydown",this._keyboardAction);},_keyboardAction:function(evt){var keyCode=evt.keyCode,escapeKey=27,key=String.fromCharCode(keyCode).toLowerCase();if(key.match(/x|o|c/)||(keyCode===escapeKey)){this.end();}else if((key==='p')||(keyCode===37)){if(this.get(ACTIVE_IMAGE)!==0){this._disableKeyboardNav();this._changeImage(this.get(ACTIVE_IMAGE)-1);}}else if((key==='n')||(keyCode===39)){if(this.get(ACTIVE_IMAGE)!==(this.get(IMAGE_ARRAY).length-1)){this._disableKeyboardNav();this._changeImage(this.get(ACTIVE_IMAGE)+1);}}},_preloadNeighborImages:function(){var activeImage=this.get(ACTIVE_IMAGE),imageArray=this.get(IMAGE_ARRAY),preloadNextImage,preloadPrevImage;if(imageArray.length>activeImage+1){preloadNextImage=new Image();preloadNextImage.src=imageArray[activeImage+1][0];}if(activeImage>0){preloadPrevImage=new Image();preloadPrevImage.src=imageArray[activeImage-1][0];}}});Y.Lightbox={init:function(config){if(lightboxInstance===null){lightboxInstance=new LB(config);}return lightboxInstance;}};M.mod_lightboxgallery=M.mod_lightboxgallery||{init:function(){var already=Y.one('#lightbox');if(already==null){Y.Lightbox.init();}}};},'@VERSION@',{requires:['base','node','anim']});